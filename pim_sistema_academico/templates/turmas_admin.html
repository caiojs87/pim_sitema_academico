{% extends "base.html" %}
{% block content %}
<div class="container-fluid mt-4">
  <h2 class="fw-bold text-unip-blue text-center mb-4">üè´ Gerenciamento de Turmas</h2>

  <!-- Criar nova turma -->
  <form method="POST" class="card p-3 shadow-sm border-0 mb-4">
    <input type="hidden" name="acao" value="criar_turma">
    <div class="row g-2">
      <div class="col-12 col-md-5">
        <input type="text" name="nome_turma" class="form-control" placeholder="Nome da turma" required>
      </div>
      <div class="col-12 col-md-4">
        <input type="text" name="codigo_turma" class="form-control" placeholder="C√≥digo (ex: ADS01)" required>
      </div>
      <div class="col-12 col-md-3">
        <button type="submit" class="btn btn-unip-yellow w-100 fw-bold">‚ûï Criar Turma</button>
      </div>
    </div>
  </form>

  {% if turmas %}
  <div class="row">
    {% for turma in turmas %}
    <div class="col-12 col-md-6 col-lg-4 mb-4">
      <div class="card border-0 shadow-sm h-100">
        <div class="card-header bg-unip-blue text-white d-flex justify-content-between align-items-center flex-wrap">
          <div>
            <strong>{{ turma.nome }}</strong> <small>({{ turma.codigo }})</small>
          </div>
          <form method="POST" style="margin:0;">
            <input type="hidden" name="acao" value="excluir_turma">
            <input type="hidden" name="codigo_turma" value="{{ turma.codigo }}">
            <button class="btn btn-danger btn-sm" onclick="return confirm('Excluir turma {{ turma.nome }}?')">üóëÔ∏è</button>
          </form>
        </div>

        <div class="card-body">
          {% if turma.alunos %}
          <div class="table-responsive">
            <table class="table table-sm table-bordered align-middle text-center">
              <thead class="table-light">
                <tr>
                  <th>Nome</th>
                  <th>NP1</th>
                  <th>NP2</th>
                  <th>PIM/AVA</th>
                  <th>Faltas</th>
                  <th>M√©dia</th>
                  <th>A√ß√µes</th>
                </tr>
              </thead>
              <tbody>
                {% for aluno in turma.alunos %}
                <tr>
                  <form method="POST" action="/turmas">
                    <input type="hidden" name="codigo_turma" value="{{ turma.codigo }}">
                    <input type="hidden" name="matricula" value="{{ aluno.matricula }}">

                    <td class="text-start">{{ aluno.nome }}</td>

                    <!-- Inputs ampliados -->
                    <td><input type="number" name="np1" value="{{ aluno.np1 or '' }}" step="0.1" class="form-control form-control-sm" style="width:80px; height:38px;"></td>
                    <td><input type="number" name="np2" value="{{ aluno.np2 or '' }}" step="0.1" class="form-control form-control-sm" style="width:80px; height:38px;"></td>
                    <td><input type="number" name="pim" value="{{ aluno.pim or '' }}" step="0.1" class="form-control form-control-sm" style="width:80px; height:38px;"></td>
                    <td><input type="number" name="faltas" value="{{ aluno.faltas or 0 }}" class="form-control form-control-sm" style="width:80px; height:38px;"></td>

                    <td class="fw-bold {% if aluno.media and aluno.media < 6 %}text-danger{% else %}text-success{% endif %}">
                      {{ aluno.media or '-' }}
                    </td>
                    <td>
                      <div class="d-flex flex-column gap-1">
                        <button type="submit" name="acao" value="atualizar_dados" class="btn btn-success btn-sm w-100">üíæ</button>
                        <button type="submit" name="acao" value="remover_aluno"
                                onclick="return confirm('Remover {{ aluno.nome }} desta turma?')"
                                class="btn btn-outline-danger btn-sm w-100">‚ùå</button>
                      </div>
                    </td>
                  </form>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
          {% else %}
          <p class="text-muted fst-italic">Nenhum aluno matriculado nesta turma.</p>
          {% endif %}

          <!-- Adicionar aluno -->
          <form method="POST" class="mt-3">
            <input type="hidden" name="acao" value="adicionar_aluno">
            <input type="hidden" name="codigo_turma" value="{{ turma.codigo }}">
            <div class="input-group">
              <select class="form-select" name="matricula" required>
                <option value="">Selecionar aluno...</option>
                {% for aluno in alunos %}
                  <option value="{{ aluno.matricula }}">{{ aluno.nome }} ({{ aluno.matricula }})</option>
                {% endfor %}
              </select>
              <button class="btn btn-unip-yellow fw-bold" type="submit">‚ûï Adicionar</button>
            </div>
          </form>
        </div>
      </div>
    </div>
    {% endfor %}
  </div>
  {% else %}
  <div class="alert alert-warning text-center">‚ö†Ô∏è Nenhuma turma cadastrada ainda.</div>
  {% endif %}

  <div class="text-center mt-4">
    <a href="/" class="btn btn-secondary">‚¨ÖÔ∏è Voltar</a>
  </div>
</div>
{% endblock %}
